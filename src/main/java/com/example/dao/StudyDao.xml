<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.dao.StudyDao">
	<select id="getList" resultType="study">
		SELECT 
				sno, id, sname, 
				content, mname, location, 
				to_char(totime,'YY-MM-DD') as totime, 
				to_char(fromtime,'YY-MM-DD') as fromtime, 
				to_char(sdate,'hh24:mi') as sdate, 
				joincode 
		FROM study
	</select>
	
	<select id="getMemberList" resultType="study">
		SELECT *
		FROM studymember
		where sno = #{sno}
	</select>
	
	<select id="getOne" parameterType="long" resultType="Study">
		SELECT  
				sno, id, sname, 
				content, mname, location, 
				to_char(totime,'YYYY-MM-DD') as totime, 
				to_char(fromtime,'YYYY-MM-DD') as fromtime, 
				to_char(sdate,'hh24:mi') as sdate, 
				joincode
		FROM study
		WHERE sno = #{sno}
	</select>
	
	<select id="getTotalCount" resultType="int">
		SELECT COUNT(*)
		FROM study
	</select>
	

	<insert id="add">
		<selectKey keyProperty="sno" order="BEFORE" resultType="int">
			select coalesce(max(sno+1),1) as sno from study
		</selectKey>
		insert into study (sno, id, sname, content, mname, location, totime, fromtime, sdate, joincode)
		values 
		(#{sno}, #{id}, #{sname}, #{content}, #{mname}, #{location}, #{totime}, #{fromtime}, to_date(#{sdate}, 'HH24:MI'), #{joincode})
	</insert>
	
	<select id="getStudyNo" resultType="int">
		select sno from study
		where id = #{id} AND joincode = #{joincode}
	</select>
	
	<select id="getJoinCode" resultType="String">
		select joincode from study
		where sno = #{sno}
	</select>
	
	<update id="groupJoin">
		<selectKey keyProperty="no" order="BEFORE" resultType="int">
			select coalesce(max(no+1),1) as sno from studymember
		</selectKey>
		insert into studymember (no, sno, id, gdate)
		values (#{no}, #{sno}, #{id}, sysdate)
	</update>
	
	<select id="isJoin" resultType="int">
		select count(*) from studymember
		where id=#{id} AND sno = #{sno}
	</select>
	
	<update id="modify">
		UPDATE study
		SET sname = #{sname},
			content = #{content},
			location = #{location},
			totime = #{totime},
			fromtime = #{fromtime},
			sdate = to_date(#{sdate}, 'HH24:MI')
		WHERE id = #{id} AND joincode = #{joincode}
	</update>
	
	
	<delete id="delete">
		DELETE FROM study
		WHERE id = #{id} AND sno = #{sno}
	</delete>
	
	<delete id="kickOut">
		DELETE FROM studymember
		WHERE sno = #{sno} AND id = #{kickedId}
	</delete>
	
</mapper>
